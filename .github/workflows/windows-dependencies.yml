name: "Windows Release Dependencies"
on:
  workflow_dispatch:
    inputs:
      xformers:
        description: 'xformers version'
        required: false
        type: string
        default: ""
      extra_dependencies:
        description: 'extra dependencies'
        required: false
        type: string
        default: "\"numpy<2\""
      cu:
        description: 'cuda version'
        required: true
        type: string
        default: "124"
      python_minor:
        description: 'python minor version'
        required: true
        type: string
        default: "11"
      python_patch:
        description: 'python patch version'
        required: true
        type: string
        default: "9"

jobs:
  build_and_release_dependencies:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.${{ inputs.python_minor }}.${{ inputs.python_patch }}
      
      - name: Download and prepare dependencies
        shell: bash
        run: |
          echo "@echo off
          call update_comfyui.bat nopause
          echo -
          echo This will try to update pytorch and all python dependencies.
          echo -
          echo If you just want to update normally, close this and run update_comfyui.bat instead.
          echo -
          pause
          ..\python_embeded\python.exe -s -m pip install --upgrade torch torchvision torchaudio ${{ inputs.xformers }} --extra-index-url https://download.pytorch.org/whl/cu${{ inputs.cu }} -r ../ComfyUI/requirements.txt pygit2
          pause" > update_comfyui_and_python_dependencies.bat
          
          python -m pip wheel --no-cache-dir torch torchvision torchaudio ${{ inputs.xformers }} ${{ inputs.extra_dependencies }} --extra-index-url https://download.pytorch.org/whl/cu${{ inputs.cu }} -r requirements.txt pygit2 -w ./cu${{ inputs.cu }}_python_deps
          
          echo "Installed dependencies:"
          ls -lah cu${{ inputs.cu }}_python_deps
          
          tar czf cu${{ inputs.cu }}_python_deps.tar.gz cu${{ inputs.cu }}_python_deps update_comfyui_and_python_dependencies.bat

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: windows-deps-cu${{ inputs.cu }}-py${{ inputs.python_minor }}.${{ inputs.python_patch }}-${{ github.run_number }}
          release_name: Windows Dependencies CUDA ${{ inputs.cu }} Python ${{ inputs.python_minor }}.${{ inputs.python_patch }} (Build ${{ github.run_number }})
          body: |
            Windows dependencies for CUDA ${{ inputs.cu }} and Python ${{ inputs.python_minor }}.${{ inputs.python_patch }}
            
            Includes:
            - PyTorch dependencies
            - ComfyUI requirements
            - Update script
          draft: false
          prerelease: true

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./cu${{ inputs.cu }}_python_deps.tar.gz
          asset_name: cu${{ inputs.cu }}_python_deps.tar.gz
          asset_content_type: application/gzip